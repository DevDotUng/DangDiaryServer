<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dangdiary.api.dao.ChallengeDAO">
  <select id="getDailyRecommendChallengeDTO" parameterType="int" resultType="com.dangdiary.api.dto.challenge.RecommendChallengeDTO">
    SELECT c.challenge_id, c.title, c.content, c.image, r.recommend_date
    FROM challenges c
    RIGHT JOIN
    (SELECT challenge_id, recommend_date
    FROM user_challenges
    WHERE user_id = #{userId}
    AND recommend_type = 'daily'
    AND start_date IS NULL LIMIT 1) r
    ON c.challenge_id = r.challenge_id
  </select>
  <select id="getRecommendChallengeDTOs" parameterType="int" resultType="com.dangdiary.api.dto.challenge.RecommendChallengeDTO">
    SELECT c.challenge_id challengeId, c.title title, c.content content, c.image image, r.recommend_date recommendDate
    FROM challenges c
    LEFT JOIN
    (SELECT challenge_id, recommend_date
    FROM user_challenges
    WHERE user_id = #{userId}
    AND recommend_type != 'daily'
    AND recommend_date IS NOT NULL
    AND start_date IS NULL) r
    ON c.challenge_id = r.challenge_id
    ORDER BY recommend_date
  </select>
  <select id="getInProgressChallengeDTOs" parameterType="int" resultType="com.dangdiary.api.dto.challenge.InProgressChallengeDTO">
    SELECT c.challenge_id challengeId, c.title title, c.content content, c.image image, r.recommend_date recommendDate
    FROM challenges c
    RIGHT JOIN
    (SELECT challenge_id, recommend_date
    FROM user_challenges
    WHERE user_id = 1
    AND start_date IS NOT NULL
    AND end_date IS NULL) r
    ON c.challenge_id = r.challenge_id
    ORDER BY recommend_date
  </select>
</mapper>